{% extends "base.html" %}

{% block title %}Executive Dashboard - PerformancePro{% endblock %}

{% block content %}
<!-- Executive Summary Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card-enterprise">
            <div class="card-header-enterprise">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1">Executive Performance Dashboard</h3>
                        <p class="mb-0 opacity-90">{{ current_month }} {{ current_year }} • Real-time Analytics</p>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-3">
                            <i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>Live
                        </span>
                        <button class="btn btn-outline-light btn-sm" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="metric-card">
            <div class="metric-value text-primary">{{ company_stats.total_employees }}</div>
            <div class="metric-label">Active Employees</div>
            <div class="metric-change text-success">
                <i class="fas fa-arrow-up me-1"></i>+2.5% vs last month
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="metric-card">
            <div class="metric-value text-success">{{ "%.1f"|format(company_stats.total_points) }}</div>
            <div class="metric-label">Total Performance Points</div>
            <div class="metric-change text-success">
                <i class="fas fa-arrow-up me-1"></i>+15.3% vs last month
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="metric-card">
            <div class="metric-value text-warning">{{ "%.0f"|format(company_stats.total_hours) }}</div>
            <div class="metric-label">Total Hours Logged</div>
            <div class="metric-change text-info">
                <i class="fas fa-minus me-1"></i>+3.2% vs last month
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="metric-card">
            <div class="metric-value text-info">₹{{ "{:,.0f}".format(company_stats.total_projected_bonus) }}</div>
            <div class="metric-label">Projected Monthly Bonus</div>
            <div class="metric-change text-success">
                <i class="fas fa-arrow-up me-1"></i>+8.7% vs last month
            </div>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="row">
    <!-- Performance Analytics -->
    <div class="col-xl-8 col-lg-7 mb-4">
        <!-- Performance Leaderboard -->
        <div class="card-enterprise mb-4">
            <div class="card-header-enterprise">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>Performance Leaderboard
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light active">This Month</button>
                        <button class="btn btn-outline-light">Last Month</button>
                        <button class="btn btn-outline-light">YTD</button>
                    </div>
                </div>
            </div>
            <div class="card-body-enterprise p-0">
                <div class="table-responsive">
                    <table class="table table-enterprise mb-0">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Employee</th>
                                <th>Department</th>
                                <th>Performance Grade</th>
                                <th>Total Points</th>
                                <th>Efficiency</th>
                                <th>Projected Bonus</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for metric in dashboard_metrics[:10] %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if loop.index <= 3 %}
                                            <div class="grade-badge grade-{{ metric.performance_grade.class }}">
                                                {{ loop.index }}
                                            </div>
                                        {% else %}
                                            <span class="badge bg-light text-dark"># {{ loop.index }}</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm me-3">
                                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                                 style="width: 40px; height: 40px; font-weight: 600;">
                                                {{ metric.employee.name[:2].upper() }}
                                            </div>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">{{ metric.employee.name }}</div>
                                            <small class="text-muted">ID: {{ metric.employee.employee_id }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <div class="fw-medium">{{ metric.employee.designation }}</div>
                                        <small class="text-muted">{{ metric.employee.department.name if metric.employee.department else 'N/A' }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="grade-badge grade-{{ metric.performance_grade.class }} me-2" style="width: 2.5rem; height: 2.5rem; font-size: 0.9rem;">
                                            {{ metric.performance_grade.grade }}
                                        </span>
                                        <small class="text-muted">{{ metric.performance_grade.desc }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="fw-semibold text-primary">{{ "%.1f"|format(metric.total_points) }}</div>
                                    <small class="text-muted">{{ "%.1f"|format(metric.avg_points_per_day) }}/day avg</small>
                                </td>
                                <td>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" style="width: {{ "%.0f"|format(metric.avg_efficiency * 100) }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.0f"|format(metric.avg_efficiency * 100) }}%</small>
                                </td>
                                <td>
                                    <div class="fw-semibold text-success">₹{{ "{:,.0f}".format(metric.projected_bonus) }}</div>
                                    <small class="text-muted">Est. this month</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('employee_performance', employee_id=metric.employee.id) }}" 
                                           class="btn btn-outline-primary" data-bs-toggle="tooltip" title="View Performance">
                                            <i class="fas fa-chart-line"></i>
                                        </a>
                                        <button class="btn btn-outline-info" onclick="exportEmployee({{ metric.employee.id }})"
                                                data-bs-toggle="tooltip" title="Export Data">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Performance Trends Chart -->
        <div class="card-enterprise">
            <div class="card-header-enterprise">
                <h5 class="mb-0">
                    <i class="fas fa-chart-area me-2"></i>Performance Trends
                </h5>
            </div>
            <div class="card-body-enterprise">
                <canvas id="performanceTrendsChart" height="120"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Analytics -->
    <div class="col-xl-4 col-lg-5">
        <!-- Department Performance -->
        <div class="card-enterprise mb-4">
            <div class="card-header-enterprise">
                <h5 class="mb-0">
                    <i class="fas fa-building me-2"></i>Department Performance
                </h5>
            </div>
            <div class="card-body-enterprise">
                <canvas id="departmentChart" height="200"></canvas>
            </div>
        </div>
        
        <!-- Performance Distribution -->
        <div class="card-enterprise mb-4">
            <div class="card-header-enterprise">
                <h5 class="mb-0">
                    <i class="fas fa-pie-chart me-2"></i>Performance Distribution
                </h5>
            </div>
            <div class="card-body-enterprise">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-success fw-medium">Exceptional (A+)</span>
                        <span class="badge bg-success">{{ dashboard_metrics|selectattr('performance_grade.grade', 'eq', 'A+')|list|length }}</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: {{ (dashboard_metrics|selectattr('performance_grade.grade', 'eq', 'A+')|list|length / dashboard_metrics|length * 100) if dashboard_metrics else 0 }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-primary fw-medium">Excellent (A)</span>
                        <span class="badge bg-primary">{{ dashboard_metrics|selectattr('performance_grade.grade', 'eq', 'A')|list|length }}</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-primary" style="width: {{ (dashboard_metrics|selectattr('performance_grade.grade', 'eq', 'A')|list|length / dashboard_metrics|length * 100) if dashboard_metrics else 0 }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-info fw-medium">Good (B+/B)</span>
                        <span class="badge bg-info">{{ (dashboard_metrics|selectattr('performance_grade.grade', 'eq', 'B+')|list|length + dashboard_metrics|selectattr('performance_grade.grade', 'eq', 'B')|list|length) }}</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-info" style="width: {{ ((dashboard_metrics|selectattr('performance_grade.grade', 'eq', 'B+')|list|length + dashboard_metrics|selectattr('performance_grade.grade', 'eq', 'B')|list|length) / dashboard_metrics|length * 100) if dashboard_metrics else 0 }}%"></div>
                    </div>
                </div>
                
                <div class="alert alert-light border-0" style="background: var(--gray-50);">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Performance grades are calculated based on average daily points and consistency metrics.
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card-enterprise mb-4">
            <div class="card-header-enterprise">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body-enterprise">
                <div class="d-grid gap-3">
                    <a href="{{ url_for('add_employee') }}" class="btn btn-primary-enterprise">
                        <i class="fas fa-user-plus me-2"></i>Add New Employee
                    </a>
                    <button class="btn btn-success-enterprise" onclick="generateMonthlyReport()">
                        <i class="fas fa-file-alt me-2"></i>Generate Monthly Report
                    </button>
                    <button class="btn btn-outline-enterprise" onclick="exportAllData()">
                        <i class="fas fa-download me-2"></i>Export All Data
                    </button>
                    <button class="btn btn-outline-enterprise" onclick="viewAnalytics()">
                        <i class="fas fa-chart-bar me-2"></i>Advanced Analytics
                    </button>
                </div>
            </div>
        </div>
        
        <!-- System Health -->
        <div class="card-enterprise">
            <div class="card-header-enterprise">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat me-2"></i>System Health
                </h5>
            </div>
            <div class="card-body-enterprise">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">Data Sync Status</span>
                    <span class="status-badge status-active">Active</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">Last Updated</span>
                    <span class="text-muted" id="lastUpdated">Just now</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">Month Progress</span>
                    <span class="fw-semibold text-primary" id="monthProgress">
                        {{ "%.0f"|format((now().day / 30 * 100) if now else 50) }}%
                    </span>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-primary" style="width: {{ "%.0f"|format((now().day / 30 * 100) if now else 50) }}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Dashboard Data and Charts
    let performanceTrendsChart, departmentChart;
    
    // Initialize Dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        startAutoRefresh(30000); // 30 seconds
        updateTimestamp();
        setInterval(updateTimestamp, 60000); // Update timestamp every minute
    });
    
    function initializeCharts() {
        initPerformanceTrendsChart();
        initDepartmentChart();
    }
    
    function initPerformanceTrendsChart() {
        const ctx = document.getElementById('performanceTrendsChart').getContext('2d');
        
        // Fetch real data from API
        fetch('/api/dashboard_metrics')
            .then(response => response.json())
            .then(apiData => {
                const data = {
                    labels: apiData.trends.labels,
                    datasets: [{
                        label: 'Average Performance Points',
                        data: apiData.trends.points,
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Target Performance',
                        data: new Array(apiData.trends.labels.length).fill(9),
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.05)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false
                    }]
                };
                
                performanceTrendsChart = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    font: { family: 'Inter' }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 12,
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: { font: { family: 'Inter' } }
                            },
                            x: {
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: { font: { family: 'Inter' } }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading performance trends:', error);
                // Fallback to demo data
                const data = {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Average Performance Points',
                        data: [8.2, 8.7, 9.1, 9.4],
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                };
                
                performanceTrendsChart = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    font: { family: 'Inter' }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 12,
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: { font: { family: 'Inter' } }
                            },
                            x: {
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: { font: { family: 'Inter' } }
                            }
                        }
                    }
                });
            });
    }
    
    function initDepartmentChart() {
        const ctx = document.getElementById('departmentChart').getContext('2d');
        
        // Fetch real department data
        fetch('/api/department_performance')
            .then(response => response.json())
            .then(apiData => {
                const data = {
                    labels: apiData.map(dept => dept.name),
                    datasets: [{
                        data: apiData.map(dept => dept.employee_count),
                        backgroundColor: [
                            'rgb(37, 99, 235)',
                            'rgb(16, 185, 129)', 
                            'rgb(245, 158, 11)',
                            'rgb(239, 68, 68)',
                            'rgb(139, 92, 246)',
                            'rgb(168, 85, 247)'
                        ],
                        borderWidth: 0
                    }]
                };
                
                departmentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { family: 'Inter', size: 12 }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading department data:', error);
                // Fallback to demo data
                const data = {
                    labels: ['Engineering', 'Product', 'Sales', 'Marketing', 'Operations'],
                    datasets: [{
                        data: [45, 25, 15, 10, 5],
                        backgroundColor: [
                            'rgb(37, 99, 235)',
                            'rgb(16, 185, 129)', 
                            'rgb(245, 158, 11)',
                            'rgb(239, 68, 68)',
                            'rgb(139, 92, 246)'
                        ],
                        borderWidth: 0
                    }]
                };
                
                departmentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { family: 'Inter', size: 12 }
                                }
                            }
                        }
                    }
                });
            });
    }
    
    // Dashboard Functions
    function refreshDashboard() {
        PerformancePro.showLoading();
        
        // Simulate API call
        setTimeout(() => {
            PerformancePro.hideLoading();
            PerformancePro.showSuccess('Dashboard refreshed successfully');
            updateTimestamp();
        }, 1500);
    }
    
    function updateTimestamp() {
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
    }
    
    function exportEmployee(employeeId) {
        const currentDate = new Date();
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        
        PerformancePro.showSuccess('Generating employee performance report...');
        
        // In real app, this would trigger actual export
        setTimeout(() => {
            window.open(`/api/export_excel/${employeeId}/${year}/${month}`, '_blank');
        }, 1000);
    }
    
    function generateMonthlyReport() {
        PerformancePro.showSuccess('Generating comprehensive monthly report...');
    }
    
    function exportAllData() {
        PerformancePro.showSuccess('Preparing enterprise data export...');
    }
    
    function viewAnalytics() {
        window.location.href = '/analytics';
    }
    
    // Real-time updates
    function startAutoRefresh(interval) {
        setInterval(() => {
            if (!document.hidden) {
                updateTimestamp();
                // In real app, would fetch latest data
            }
        }, interval);
    }
</script>
{% endblock %}
